#!/usr/bin/env python3
"""
Скрипт обновления описаний автомобилей: марка, модель, тип кузова, годы выпуска и факты о модели.
Факты — только о модели (не о марке), для каждой модели по возможности свои.
"""

import sys
from sqlalchemy import create_engine, text
from sqlalchemy.orm import sessionmaker


# Факты именно о моделях (не о марках). Для неизвестных моделей берём нейтральные фразы по хешу — у каждой модели свои.
MODEL_FACTS_DB = {
    "Rolls-Royce": {
        "Silver Ghost": [
            "Был назван 'Best car in the world' в 1907 году.",
            "Производился с 1906 по 1925 год, всего выпущено около 7 874 автомобиля.",
        ],
        "Phantom": [
            "Первый Phantom выпущен в 1925 году.",
            "Собирается вручную, срок сборки — несколько месяцев.",
        ],
    },
    "Ford": {
        "Model T": [
            "Выпускался с 1908 по 1927 год, выпущено более 15 миллионов экземпляров.",
            "Сделал авто доступными для среднего класса благодаря конвейерной сборке.",
        ],
        "Mustang": [
            "Дебютировал на Нью-Йоркской ярмарке 1964 года.",
            "Стал первым пони-каром и породил целый класс автомобилей.",
        ],
    },
    "Mercedes-Benz": {
        "Simplex": [
            "Производился с 1902 по 1926 год.",
            "Один из первых автомобилей с передним двигателем и задним приводом.",
        ],
        "SLR McLaren": [
            "Выпускался ограниченным тиражом с 2003 по 2010 год.",
            "Использовал технологии Formula 1, включая углепластик в кузове.",
        ],
    },
    "Porsche": {
        "911": [
            "Дебютировал в 1964 году как 901/902.",
            "Один из самых долго выпускающихся спортивных автомобилей в истории.",
        ],
    },
    "Ferrari": {
        "250 GTO": [
            "Произведено всего 36 экземпляров (1962–1964).",
            "Один из самых ценных автомобилей в мире.",
        ],
    },
    "Chevrolet": {
        "Corvette": [
            "Первый Corvette представлен в 1953 году.",
            "Американский спорткар, выпускается более 70 лет.",
        ],
    },
    "BMW": {
        "2002 Turbo": [
            "Первый серийный турбонаддувный автомобиль в Европе.",
            "Выпускался в 1973–1975 годах, около 1600 экземпляров.",
        ],
    },
    "Aston Martin": {
        "DB5": [
            "Представлен в 1963 году, известен по фильмам о Джеймсе Бонде.",
            "Имел 4.0-литровый рядный шестицилиндровый двигатель 282 л.с.",
        ],
    },
    "Lamborghini": {
        "Miura": [
            "Дебютировал в 1966 году и изменил представление о суперкарах.",
            "Первый серийный суперкар с центральным расположением двигателя.",
        ],
    },
    "Jaguar": {
        "E-Type": [
            "Дебютировал в 1961 году; Энцо Феррари назвал его самым красивым автомобилем.",
            "Для своего времени имел рекордную скорость 240 км/ч.",
        ],
    },
    "Toyota": {
        "Camry": [
            "Одна из самых продаваемых моделей в мире в классе седанов.",
            "Неоднократно лидировала по продажам в США в своём сегменте.",
        ],
        "Land Cruiser": [
            "Выпускается с 1951 года, одна из самых надёжных внедорожных моделей.",
            "Популярен в странах с тяжёлыми дорожными условиями.",
        ],
    },
    "Volkswagen": {
        "Golf": [
            "Один из самых продаваемых автомобилей в Европе за всю историю.",
            "Выпускается с 1974 года, множество поколений и модификаций.",
        ],
        "Polo": [
            "Компактный хэтчбек, многократно обновлялся с 1975 года.",
            "Популярен в Европе и других рынках как доступный городской автомобиль.",
        ],
    },
    "Hyundai": {
        "Solaris": [
            "Создан для рынков России и СНГ, седан и лифтбек.",
            "Собирался в том числе в России.",
        ],
        "Tucson": [
            "Компактный кроссовер, выпускается с 2004 года.",
            "Предлагается с бензиновыми, дизельными и гибридными двигателями.",
        ],
    },
    "Kia": {
        "Rio": [
            "Компактный седан и хэтчбек, один из лидеров продаж в России.",
            "Несколько поколений, доступен с механической и автоматической КПП.",
        ],
        "Sportage": [
            "Кроссовер, выпускается с 1993 года.",
            "Неоднократно обновлялся, популярен в Европе и России.",
        ],
    },
    "Lada": {
        "Vesta": [
            "Седан и универсал, один из флагманов российского автопрома.",
            "Выпускается с 2015 года на платформе Lada B/C.",
        ],
        "Granta": [
            "Доступный седан и лифтбек для российского рынка.",
            "Выпускается с 2011 года, неоднократно модернизировался.",
        ],
    },
    "Škoda": {
        "Octavia": [
            "Один из самых продаваемых автомобилей марки, седан и универсал.",
            "Использует платформу Volkswagen Group, известен просторным салоном.",
        ],
        "Kodiaq": [
            "Семейный кроссовер с семиместной опцией.",
            "Выпускается с 2016 года, доступен с разными типами приводов.",
        ],
    },
    "Renault": {
        "Logan": [
            "Доступный седан и универсал, популярен в России и СНГ.",
            "Первый Logan представлен в 2004 году.",
        ],
        "Duster": [
            "Компактный внедорожник с несущим кузовом.",
            "Выпускается с 2010 года, популярен в том числе в России.",
        ],
    },
    "Nissan": {
        "Qashqai": [
            "Один из первых массовых кроссоверов в Европе, с 2006 года.",
            "Неоднократно обновлялся, предлагается с передним и полным приводом.",
        ],
        "X-Trail": [
            "Компактный кроссовер с опцией полного привода.",
            "Выпускается с 2000 года, несколько поколений.",
        ],
    },
    "Honda": {
        "Civic": [
            "Компактный седан и хэтчбек, выпускается с 1972 года.",
            "Известен надёжностью и спортивными версиями Type R.",
        ],
        "CR-V": [
            "Кроссовер, один из пионеров класса в середине 1990-х.",
            "Выпускается с 1995 года, несколько поколений.",
        ],
    },
    "Mazda": {
        "3": [
            "Компактный седан и хэтчбек с двигателями SkyActiv.",
            "Известен управляемостью и обновлённым дизайном.",
        ],
        "CX-5": [
            "Кроссовер среднего класса, выпускается с 2012 года.",
            "Предлагается с бензиновыми и дизельными двигателями.",
        ],
    },
    "Audi": {
        "A4": [
            "Бизнес-седан и универсал, выпускается с 1994 года.",
            "Многократно обновлялся, доступен с полным приводом Quattro.",
        ],
        "Q5": [
            "Премиальный компактный кроссовер с 2008 года.",
            "Платформа MLB, бензиновые и дизельные моторы, гибриды.",
        ],
    },
    "Lexus": {
        "RX": [
            "Премиальный кроссовер, выпускается с 1998 года.",
            "Один из самых продаваемых моделей Lexus в мире.",
        ],
        "ES": [
            "Представительский седан на платформе Toyota Camry.",
            "Известен комфортом и тихой работой салона.",
        ],
    },
    "Volvo": {
        "XC60": [
            "Среднеразмерный кроссовер, с 2008 года.",
            "Ассоциируется с безопасностью и скандинавским дизайном.",
        ],
        "S60": [
            "Бизнес-седан, выпускается с 2000 года.",
            "Доступен с бензиновыми, гибридными и подзаряжаемыми гибридными силовыми установками.",
        ],
    },
}

# Нейтральные фразы о модели (не о марке) — для неизвестных моделей. Выбираем по хешу, чтобы у каждой модели были свои.
GENERIC_MODEL_FACTS = [
    "Модель предлагается в нескольких комплектациях.",
    "Популярна на вторичном рынке благодаря соотношению цена–качество.",
    "Доступна с разными типами трансмиссий.",
    "Регулярно обновлялась в рамках рестайлингов.",
    "Предлагается в кузовах под разные задачи.",
    "Хорошо держит остаточную стоимость при аккуратной эксплуатации.",
    "Подходит для городской и загородной эксплуатации.",
    "Имеет развитую сеть сервисного обслуживания.",
    "Модель известна практичной компоновкой салона.",
    "Выпускалась несколькими поколениями.",
    "Популярна в своём классе на российском рынке.",
    "Доступна с передним и полным приводом в зависимости от комплектации.",
    "Отличается сбалансированными ходовыми качествами.",
    "Подходит для семейной эксплуатации.",
    "Предлагается с бензиновыми и дизельными двигателями.",
    "Модель регулярно получала высокие оценки в тестах.",
    "Имеет просторный багажник для своего класса.",
    "Подходит для длительных поездок.",
    "Популярна среди корпоративных клиентов.",
    "Выпускается на современных сборочных линиях.",
]


def get_model_facts(brand: str, model: str) -> list[str]:
    """Возвращает факты только о модели (не о марке). Для неизвестных моделей — разные нейтральные фразы по хешу."""
    if brand in MODEL_FACTS_DB and model in MODEL_FACTS_DB[brand]:
        return MODEL_FACTS_DB[brand][model]
    # Детерминированный выбор 2 фраз по хешу от (марка + модель), чтобы у каждой модели были свои
    key = (brand + "|" + model).encode("utf-8")
    h = hash(key) % (1 << 32)
    n = len(GENERIC_MODEL_FACTS)
    i1 = h % n
    i2 = (h // n) % n
    if i1 == i2:
        i2 = (i2 + 1) % n
    return [GENERIC_MODEL_FACTS[i1], GENERIC_MODEL_FACTS[i2]]


def enhance_car_descriptions(db_url: str) -> None:
    """
    Обновляет description у автомобилей: марка, модель, тип кузова, годы выпуска, факты о модели.
    """
    print("Обновление описаний: марка, модель, тип кузова, годы выпуска, факты о модели...")

    engine = create_engine(db_url, pool_pre_ping=True)
    Session = sessionmaker(bind=engine)
    db = Session()

    try:
        # Годы выпуска по паре (mark_name, model_name): min и max год
        print("Сбор годов выпуска по марке–модели...")
        result = db.execute(text("""
            SELECT mark_name, model_name, MIN(year) AS min_year, MAX(year) AS max_year
            FROM cars
            WHERE year IS NOT NULL
            GROUP BY mark_name, model_name
        """))
        year_ranges = {(row[0], row[1]): (row[2], row[3]) for row in result.fetchall()}

        # Все машины с нужными полями (в т.ч. без description — заполняем с нуля)
        result = db.execute(text("""
            SELECT id, mark_name, model_name, body_type, year
            FROM cars
            LIMIT 100000
        """))
        cars = result.fetchall()
        print(f"Найдено машин для обновления: {len(cars)}")

        updated = 0
        for car in cars:
            car_id, mark_name, model_name, body_type, year = car
            min_y, max_y = year_ranges.get((mark_name, model_name), (year, year))
            if min_y is None:
                min_y, max_y = year, year
            if min_y is not None and max_y is not None:
                years_str = f"{min_y}–{max_y}" if (min_y != max_y) else str(min_y)
            else:
                years_str = "не указаны"

            parts = [f"{mark_name} {model_name}."]
            if body_type and body_type.strip():
                parts.append(f"Тип кузова: {body_type.strip()}.")
            parts.append(f"Годы выпуска: {years_str}.")

            facts = get_model_facts(mark_name, model_name)
            facts_text = " ".join(f.strip().rstrip(".") for f in facts[:2])
            if facts_text:
                parts.append(facts_text + ".")

            description = " ".join(parts)

            db.execute(
                text("UPDATE cars SET description = :desc WHERE id = :car_id"),
                {"desc": description, "car_id": car_id},
            )
            updated += 1
            if updated % 5000 == 0:
                db.commit()
                print(f"  Обновлено {updated} машин...")

        db.commit()
        print(f"Всего обновлено описаний: {updated}")

        # Примеры
        result = db.execute(text("""
            SELECT mark_name, model_name, body_type, description
            FROM cars
            WHERE description IS NOT NULL
            LIMIT 5
        """))
        samples = result.fetchall()
        print("\nПримеры описаний:")
        for row in samples:
            print(f"  {row[0]} {row[1]} ({row[2] or '—'}):")
            print(f"    {row[3][:220]}{'...' if len(row[3]) > 220 else ''}")
            print()

    except Exception as e:
        db.rollback()
        print(f"Ошибка при обновлении описаний: {e}")
        raise
    finally:
        db.close()


def main() -> None:
    db_url = "postgresql+psycopg://carmatch:carmatch@localhost:5433/carmatch"
    print("Запуск обновления описаний...")
    print(f"БД: {db_url}")
    try:
        enhance_car_descriptions(db_url)
        print("Готово.")
    except Exception as e:
        print(f"Ошибка: {e}")
        sys.exit(1)


if __name__ == "__main__":
    main()
